services:
  localstack:
    image: localstack/localstack:2.3
    container_name: jobmatch-localstack
    ports:
      - '4566:4566'
    environment:
      - SERVICES=dynamodb,sqs,s3
      - AWS_DEFAULT_REGION=us-east-1
      - AWS_ACCESS_KEY_ID=test
      - AWS_SECRET_ACCESS_KEY=test
      - LOCALSTACK_HOSTNAME=localstack
      - DATA_DIR=/tmp/localstack
    volumes:
      - localstack_data:/tmp/localstack
      - ./docker/localstack/entrypoint.sh:/app/docker-entrypoint.sh
      - /var/run/docker.sock:/var/run/docker.sock
    entrypoint: /app/docker-entrypoint.sh
    healthcheck:
      test:
        [
          'CMD',
          'bash',
          '-c',
          'curl -s http://localhost:4566/_localstack/health | grep -q available || exit 1',
        ]
      interval: 3s
      timeout: 5s
      retries: 10
      start_period: 15s
    networks:
      - jobmatch-network

  auth-service:
    build:
      context: .
      dockerfile: services/auth-service/Dockerfile
    container_name: jobmatch-auth-service
    ports:
      - '${AUTH_SERVICE_PORT}:${AUTH_SERVICE_PORT}'
    volumes:
      - ./.env:/app/.env:ro
    environment:
      NODE_ENV: ${NODE_ENV}
      AUTH_SERVICE_PORT: ${AUTH_SERVICE_PORT}
      CORS_ORIGIN: ${CORS_ORIGIN}
      S3_ENDPOINT: ${S3_ENDPOINT}
      S3_BUCKET: ${S3_BUCKET}
      DYNAMODB_ENDPOINT: ${DYNAMODB_ENDPOINT}
      DYNAMODB_TABLE_USERS: ${DYNAMODB_TABLE_USERS}
      AWS_REGION: ${AWS_REGION}
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY}
      JWT_SECRET: ${JWT_SECRET}
      SMTP_HOST: ${SMTP_HOST}
      SMTP_PORT: ${SMTP_PORT}
    depends_on:
      localstack:
        condition: service_healthy
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:3001/health']
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s
    networks:
      - jobmatch-network
    restart: unless-stopped

  mailhog:
    image: mailhog/mailhog:latest
    container_name: jobmatch-mailhog
    ports:
      - '1025:1025'
      - '8025:8025'
    healthcheck:
      test: ['CMD', 'nc', '-z', 'localhost', '1025']
      interval: 5s
      timeout: 3s
      retries: 5
    networks:
      - jobmatch-network

networks:
  jobmatch-network:
    driver: bridge

volumes:
  localstack_data:
    driver: local
