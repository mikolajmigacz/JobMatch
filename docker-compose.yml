services:
  localstack:
    image: localstack/localstack:2.3
    container_name: jobmatch-localstack
    ports:
      - '4566:4566'
    environment:
      - SERVICES=dynamodb,sqs,s3
      - AWS_DEFAULT_REGION=us-east-1
      - AWS_ACCESS_KEY_ID=test
      - AWS_SECRET_ACCESS_KEY=test
      - LOCALSTACK_HOSTNAME=localstack
      - DATA_DIR=/tmp/localstack
    volumes:
      - localstack_data:/tmp/localstack
      - /var/run/docker.sock:/var/run/docker.sock
    entrypoint: []
    command: bash -c "chmod +x /usr/local/bin/docker-entrypoint.sh && /usr/local/bin/docker-entrypoint.sh"
    healthcheck:
      test:
        [
          'CMD',
          'bash',
          '-c',
          'curl -s http://localhost:4566/_localstack/health | grep -q available || exit 1',
        ]
      interval: 3s
      timeout: 5s
      retries: 10
      start_period: 15s
    networks:
      - jobmatch-network

  auth-service:
    build:
      context: .
      dockerfile: services/auth-service/Dockerfile
    container_name: jobmatch-auth-service
    ports:
      - '${AUTH_SERVICE_PORT}:${AUTH_SERVICE_PORT}'
    environment:
      NODE_ENV: ${NODE_ENV}
      AUTH_SERVICE_PORT: ${AUTH_SERVICE_PORT}
      CORS_ORIGIN: ${CORS_ORIGIN}
      S3_ENDPOINT: ${S3_ENDPOINT}
      S3_BUCKET: ${S3_BUCKET}
      DYNAMODB_ENDPOINT: ${DYNAMODB_ENDPOINT}
      DYNAMODB_TABLE_USERS: ${DYNAMODB_TABLE_USERS}
      AWS_REGION: ${AWS_REGION}
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY}
      JWT_SECRET: ${JWT_SECRET}
      SMTP_HOST: ${SMTP_HOST}
      SMTP_PORT: ${SMTP_PORT}
    depends_on:
      localstack:
        condition: service_healthy
      mailhog:
        condition: service_healthy
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:${AUTH_SERVICE_PORT}/health']
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s
    networks:
      - jobmatch-network
    restart: unless-stopped

  user-service:
    build:
      context: .
      dockerfile: services/user-service/Dockerfile
    container_name: jobmatch-user-service
    ports:
      - '${USER_SERVICE_PORT}:${USER_SERVICE_PORT}'
    environment:
      NODE_ENV: ${NODE_ENV}
      USER_SERVICE_PORT: ${USER_SERVICE_PORT}
      CORS_ORIGIN: ${CORS_ORIGIN}
      S3_ENDPOINT: ${S3_ENDPOINT}
      S3_BUCKET: ${S3_BUCKET}
      DYNAMODB_ENDPOINT: ${DYNAMODB_ENDPOINT}
      DYNAMODB_TABLE_USERS: ${DYNAMODB_TABLE_USERS}
      AWS_REGION: ${AWS_REGION}
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY}
      JWT_SECRET: ${JWT_SECRET}
    depends_on:
      localstack:
        condition: service_healthy
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:${USER_SERVICE_PORT}/health']
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s
    networks:
      - jobmatch-network
    restart: unless-stopped

  job-service:
    build:
      context: .
      dockerfile: services/job-service/Dockerfile
    container_name: jobmatch-job-service
    ports:
      - '${JOB_SERVICE_PORT}:${JOB_SERVICE_PORT}'
    environment:
      NODE_ENV: ${NODE_ENV}
      JOB_SERVICE_PORT: ${JOB_SERVICE_PORT}
      CORS_ORIGIN: ${CORS_ORIGIN}
      DYNAMODB_ENDPOINT: ${DYNAMODB_ENDPOINT}
      DYNAMODB_TABLE_JOBS: ${DYNAMODB_TABLE_JOBS}
      AWS_REGION: ${AWS_REGION}
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY}
      JWT_SECRET: ${JWT_SECRET}
    depends_on:
      localstack:
        condition: service_healthy
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:${JOB_SERVICE_PORT}/health']
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s
    networks:
      - jobmatch-network
    restart: unless-stopped

  application-service:
    build:
      context: .
      dockerfile: services/application-service/Dockerfile
    container_name: jobmatch-application-service
    ports:
      - '${APPLICATION_SERVICE_PORT}:${APPLICATION_SERVICE_PORT}'
    environment:
      NODE_ENV: ${NODE_ENV}
      APPLICATION_SERVICE_PORT: ${APPLICATION_SERVICE_PORT}
      CORS_ORIGIN: ${CORS_ORIGIN}
      DYNAMODB_ENDPOINT: ${DYNAMODB_ENDPOINT}
      DYNAMODB_TABLE_APPLICATIONS: ${DYNAMODB_TABLE_APPLICATIONS}
      AWS_REGION: ${AWS_REGION}
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY}
      JWT_SECRET: ${JWT_SECRET}
      SQS_ENDPOINT: ${SQS_ENDPOINT}
      SQS_QUEUE_URL: ${SQS_QUEUE_URL}
    depends_on:
      localstack:
        condition: service_healthy
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:${APPLICATION_SERVICE_PORT}/health']
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s
    networks:
      - jobmatch-network
    restart: unless-stopped

  mailhog:
    image: mailhog/mailhog:latest
    container_name: jobmatch-mailhog
    ports:
      - '1025:1025'
      - '8025:8025'
    healthcheck:
      test: ['CMD', 'nc', '-z', 'localhost', '1025']
      interval: 5s
      timeout: 3s
      retries: 5
    networks:
      - jobmatch-network

networks:
  jobmatch-network:
    driver: bridge

volumes:
  localstack_data:
    driver: local
